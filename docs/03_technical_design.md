# 技术设计文档

## 3.1 整体架构设计

### 架构模式
采用 **分层架构 + 微服务化** 设计模式

```
┌─────────────────────────────────────────────────────────────┐
│                    前端展示层 (Frontend)                      │
├─────────────────────────────────────────────────────────────┤
│                    API 网关层 (Gateway)                      │
├─────────────────────────────────────────────────────────────┤
│                    业务服务层 (Services)                      │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐ │
│  │ 用户管理服务 │ │ 任务管理服务 │ │ 采集服务    │ │ 转录服务 │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘ │
├─────────────────────────────────────────────────────────────┤
│                    数据访问层 (Data Access)                   │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐ │
│  │ 用户数据    │ │ 任务数据    │ │ 文件存储    │ │ 缓存    │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘ │
├─────────────────────────────────────────────────────────────┤
│                    基础设施层 (Infrastructure)                │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐ │
│  │ 数据库      │ │ 消息队列    │ │ 文件系统    │ │ 外部API │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 3.2 核心模块设计

### 3.2.1 用户管理模块
```python
# 基于现有 JWT 认证系统扩展
class UserService:
    - 用户注册/登录
    - 权限管理
    - 配额控制
    - 任务历史记录
```

### 3.2.2 任务管理模块
```python
class TaskManager:
    - 任务创建和调度
    - 状态跟踪
    - 进度更新
    - 错误处理
    - 任务暂停/恢复
```

### 3.2.3 视频采集模块
```python
class VideoScraper:
    - Selenium 浏览器控制
    - 反爬虫策略
    - 数据清洗
    - 错误重试
```

### 3.2.4 语音识别模块
```python
class AudioTranscriber:
    - 音频下载 (yt-dlp)
    - 语音转录 (Faster-Whisper)
    - 质量优化
    - 并发控制
```

## 3.3 数据模型设计

### 3.3.1 用户模型
```python
class User:
    id: int
    username: str
    email: str
    quota_remaining: int
    created_at: datetime
    last_login: datetime
```

### 3.3.2 任务模型
```python
class AnalysisTask:
    id: str
    user_id: int
    target_url: str
    status: str  # pending, running, completed, failed
    progress: int
    created_at: datetime
    completed_at: datetime
    result_file: str
    error_message: str
```

### 3.3.3 视频数据模型
```python
class VideoData:
    video_id: str
    title: str
    url: str
    transcript: str
    duration: int
    created_at: datetime
    task_id: str
```

## 3.4 技术栈选择

### 后端技术
- **Web 框架**：Flask (现有)
- **数据库**：SQLite (开发) / PostgreSQL (生产)
- **任务队列**：Celery + Redis
- **ORM**：SQLAlchemy (现有)

### 前端技术
- **模板引擎**：Jinja2 (现有)
- **UI 框架**：Bootstrap 5 (现有)
- **JavaScript**：原生 JS + Fetch API

### 第三方服务
- **浏览器自动化**：Selenium + ChromeDriver
- **音频下载**：yt-dlp
- **语音识别**：Faster-Whisper
- **消息队列**：Redis

## 3.5 部署架构

### 开发环境
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Flask     │    │   Redis     │    │   SQLite    │
│   App       │◄──►│   Queue     │◄──►│   Database  │
└─────────────┘    └─────────────┘    └─────────────┘
```

### 生产环境
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Nginx     │    │   Flask     │    │ PostgreSQL  │
│   Reverse   │◄──►│   App       │◄──►│   Database  │
│   Proxy     │    │   (Gunicorn)│    │             │
└─────────────┘    └─────────────┘    └─────────────┘
        │                   │
        ▼                   ▼
┌─────────────┐    ┌─────────────┐
│   Static    │    │   Redis     │
│   Files     │    │   Queue     │
└─────────────┘    └─────────────┘
```

## 3.6 安全设计

### 认证与授权
- JWT Token 认证
- 基于角色的访问控制
- API 接口权限验证

### 数据安全
- 本地数据存储
- 敏感信息加密
- 定期数据清理

### 系统安全
- 输入验证和过滤
- SQL 注入防护
- XSS 攻击防护

## 3.7 性能优化

### 缓存策略
- Redis 缓存任务状态
- 文件系统缓存音频
- 数据库查询优化

### 并发控制
- 任务队列管理
- 资源池限制
- 负载均衡

### 监控与告警
- 系统资源监控
- 任务执行监控
- 错误日志记录
